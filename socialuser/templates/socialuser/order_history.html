{% extends 'layouts/blank.html' %}
{% load static %}

{% block content %}
<!-- blank header spacing-->
<section class="ftco-section-blank-small"></section>

<section class="ftco-subpage-section">
    <div class="container">
        <div class="imgbox">
            <div class="svg-box-2"><img src= {% static 'images/coffee_title_bg-01.svg' %} class="noise_animation change-svg-color"></div>
        </div>
        <div class="row justify-content-center mt-5">
            <div class="col col-lg-8 mb-5">
                <h1 class="mb-5">訂單紀錄</h1>
                
                {% if orders %}
                <div class="order-list">
                    {% for order in orders %}
                    <div class="order-item mb-5 p-5 rounded">
                        <div class="d-flex justify-content-between mb-3">
                            <div>
                                <h5>訂單編號: #{{ order.id }}</h5>
                                <p class="text-muted mb-0">
                                    訂單時間: {{ order.created_at|date:"Y-m-d H:i" }}
                                </p>
                                <!-- 添加取餐码信息 -->
                                <p class="mb-0">
                                    <strong>取餐码:</strong> 
                                    <span class="h5 color-theme">{{ order.pickup_code }}</span>
                                </p>
                                <!-- 统一的订单状态显示 -->
                                <div class="mt-2">
                                    {% if order.is_paid %}
                                        {% if order.status == 'preparing' %}
                                            <span class="badge badge-orange preparing-countdown" data-order-id="{{ order.id }}">
                                                <i class="fas fa-check-circle mr-1"></i>已支付 - 製作中: 
                                                <span class="countdown-minutes">
                                                    {% with remaining=order.get_remaining_minutes %}
                                                    {% if remaining > 0 %}
                                                        {{ remaining }}分鐘
                                                    {% else %}
                                                        即將完成
                                                    {% endif %}
                                                    {% endwith %}
                                                </span>
                                            </span>
                                        {% elif order.status == 'ready' %}
                                            <span class="badge badge-success">
                                                <i class="fas fa-mug-hot mr-1"></i>已就绪，请取餐
                                            </span>
                                        {% elif order.status == 'completed' %}
                                            <span class="badge badge-info">
                                                <i class="fas fa-check-double mr-1"></i>{{ order.get_status_display_with_timing }}
                                            </span>
                                        {% else %}
                                            <span class="badge badge-secondary">
                                                {{ order.get_status_display }}
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        {% if order.payment_status == 'pending' and not order.is_payment_timeout %}
                                            <!-- 修改：待支付徽章中的minutes改为分鐘 -->
                                            <span class="badge badge-warning payment-countdown">
                                                <i class="fas fa-hourglass-half mr-1"></i>
                                                待支付 - 剩余: <span class="countdown-text">{{ order.payment_timeout|timeuntil }}</span>
                                            </span>
                                        {% elif order.is_payment_timeout or order.payment_status == 'cancelled' %}
                                            <!-- 恢复显示取消/超时徽章 -->
                                            <span class="badge badge-danger">
                                                <i class="fas fa-times-circle mr-1"></i>订单已取消/超时
                                            </span>
                                        {% else %}
                                            <span class="badge badge-secondary">
                                                {{ order.get_payment_status_display }}
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <!-- 隐藏快速订单徽章，但保留逻辑 -->
                                    {% if order.is_quick_order %}
                                    <span class="badge badge-success ml-1" style="display: none;">
                                        <i class="fas fa-bolt mr-1"></i>快速訂單
                                    </span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="text-right">
                                <span class="h5 pr-2">${{ order.total_price|floatformat:2 }}</span>
                            </div>
                        </div>
                        
                        <div class="order-items">
                            {% for item in order.get_items_with_chinese_options %}
                            <div class="d-flex align-items-center mb-3">
                                <div class="mr-3">
                                    <div class="p-2 rounded d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                        <!-- 修改：确保图片路径正确 -->
                                        {% if item.image %}
                                            <img src="{{ item.image }}" alt="{{ item.name }}" class="img-fluid" style="max-height: 75px;" onerror="this.src='/static/images/default-product.png'">
                                        {% else %}
                                            <img src="/static/images/default-product.png" alt="{{ item.name }}" class="img-fluid" style="max-height: 75px;">
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{{ item.name }}</h6>
                                    <p class="mb-1 text-muted">
                                        數量: {{ item.quantity }} 
                                    </p>
                                    <div class="text-muted">
                                        {% if item.cup_level_cn %} 杯型: {{ item.cup_level_cn }}{% endif %}
                                        {% if item.milk_level_cn %} | 牛奶: {{ item.milk_level_cn }}{% endif %}
                                        {% if item.grinding_level_cn %} | 研磨: {{ item.grinding_level_cn }}{% endif %}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="h6">${{ item.total_price|floatformat:2 }}</span>
                                    <div class="text-muted small">${{ item.price|floatformat:2 }} / 單價</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                            <div>
                                <!-- 保留商品数量信息文本，但取消badge样式 -->
                                <span class="text-muted">{{ order.get_items|length }} 項商品</span>
                            </div>

                            <!-- 订单操作按钮 -->
                            <div>
                                {% if order.is_paid and order.status == 'completed' %}
                                    <!-- 隐藏"订单已完成"信息文本，但保留逻辑 -->
                                    <span class="text-success" style="display: none;">
                                        <i class="fas fa-check-circle mr-1"></i>订单已完成
                                    </span>
                                {% elif order.is_paid and order.status == 'ready' %}
                                    <!-- 隐藏"已就绪，请取餐"信息文本，但保留逻辑 -->
                                    <span class="text-success" style="display: none;">
                                        <i class="fas fa-mug-hot mr-1"></i>已就绪，请取餐
                                    </span>
                                {% elif order.is_paid and order.status == 'preparing' %}
                                    <!-- 隐藏"制作中，请稍候"信息文本，但保留逻辑 -->
                                    <span class="text-warning" style="display: none;">
                                        <i class="fas fa-clock mr-1"></i>制作中，请稍候
                                    </span>
                                {% elif order.payment_status == 'pending' and not order.is_payment_timeout %}
                                    <a href="{% url 'eshop:continue_payment' order.id %}" 
                                    class="btn btn-primary btn-sm">
                                        <i class="fas fa-credit-card mr-1"></i>繼續支付
                                    </a>
                                {% else %}
                                    <!-- 隐藏取消/超时文本，但保留逻辑 -->
                                    <span class="text-danger small" style="display: none;">
                                        <i class="fas fa-times-circle mr-1"></i>订单已取消/超时
                                    </span>
                                {% endif %}
                                
                                <!-- 隐藏详情按钮，但保留逻辑 -->
                                <a href="{% url 'eshop:order_detail' order.id %}" 
                                   class="btn btn-outline-secondary btn-sm ml-2" style="display: none;">
                                    <i class="fas fa-info-circle mr-1"></i>詳情
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="icon-shopping-bag h1 text-muted"></i>
                    </div>
                    <h4>暫無訂單</h4>
                    <p class="text-muted">您購買後，訂單歷史將在此顯示</p>
                    <a href="{% url 'coffee_menu' %}" class="btn btn-primary">
                        瀏覽選單
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<div class="flexable-vh-20"></div>

<style>
/* 确保隐藏的元素不会占用空间 */
[style*="display: none"] {
    display: none !important;
}

/* 商品数量文本样式 */
.text-muted {
    color: #6c757d !important;
    font-size: 0.9rem;
}

/* 修改：自定义橙色徽章样式 */
.badge-orange {
    background-color: #fd7e14;
    color: white;
    border: none;
}

/* 已就绪样式 */
.badge-success {
    background-color: #28a745;
    color: white;
}

/* 取消/超时样式 */
.badge-danger {
    background-color: #dc3545;
    color: white;
}

/* 支付倒计时样式 */
.payment-countdown {
    background: linear-gradient(135deg, #ffc107, #ff9800);
    border: none;
    box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
    color: #fff;
}

.payment-countdown .countdown-text {
    font-weight: bold;
}

/* 制作中倒计时样式 */
.preparing-countdown .countdown-minutes {
    font-weight: bold;
    color: #fff;
}

/* 取餐码样式 */
.text-primary {
    color: #007bff !important;
    font-weight: bold;
}
</style>

<script>
// 自动显示提醒
function checkAndShowPaymentReminders() {
    fetch('/eshop/api/pending-orders/')
        .then(response => response.json())
        .then(data => {
            if (data.has_urgent) {
                const urgentOrder = data.orders.find(order => order.minutes_remaining <= 5);
                if (urgentOrder && window.paymentReminder) {
                    // 延迟2秒显示，让页面完全加载
                    setTimeout(() => {
                        window.paymentReminder.showReminder(urgentOrder);
                    }, 2000);
                }
            }
        });
}

// 制作中订单实时倒计时
class PreparingCountdown {
    constructor() {
        this.timers = new Map();
        this.updateInterval = 60000; // 1分钟更新一次
    }

    start() {
        console.log('启动制作中订单倒计时监控');
        
        // 立即更新所有制作中订单
        this.updateAllPreparingOrders();
        
        // 每分钟更新一次
        setInterval(() => {
            this.updateAllPreparingOrders();
        }, this.updateInterval);
    }

    updateAllPreparingOrders() {
        const preparingBadges = document.querySelectorAll('.preparing-countdown');
        
        preparingBadges.forEach(badge => {
            const orderId = badge.getAttribute('data-order-id');
            this.updateOrderCountdown(orderId, badge);
        });
    }

    async updateOrderCountdown(orderId, badgeElement) {
        try {
            const response = await fetch(`/eshop/countdown/${orderId}/`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                console.error(`订单 ${orderId} 获取倒计时数据失败:`, data.error);
                return;
            }
            
            console.log(`订单 ${orderId} 倒计时数据:`, data);
            this.updateBadgeDisplay(badgeElement, data);
            
        } catch (error) {
            console.error(`订单 ${orderId} 倒计时更新失败:`, error);
        }
    }

    updateBadgeDisplay(badgeElement, data) {
        const countdownElement = badgeElement.querySelector('.countdown-minutes');
        
        if (!countdownElement) {
            console.error('找不到倒计时显示元素');
            return;
        }

        // 根据API返回的状态更新显示
        if (data.is_ready || data.status === 'ready' || data.status === 'completed') {
            // 制作完成，切换到"已就绪"状态
            console.log(`订单 ${data.order_id} 制作完成，切换到已就绪状态`);
            
            // 创建新的已就绪徽章
            const readyBadge = document.createElement('span');
            readyBadge.className = 'badge badge-success';
            readyBadge.innerHTML = '<i class="fas fa-mug-hot mr-1"></i>已就绪，请取餐';
            
            // 替换原来的徽章
            badgeElement.parentNode.replaceChild(readyBadge, badgeElement);
            
        } else {
            // 制作中，更新倒计时文字
            const minutes = data.remaining_minutes;
            let displayText;
            
            if (minutes > 1) {
                displayText = `${minutes}分鐘`;
            } else if (minutes === 1) {
                displayText = '1分鐘';
            } else {
                displayText = '即將完成';
            }
            
            countdownElement.textContent = displayText;
        }
    }
}

// 页面加载后执行
document.addEventListener('DOMContentLoaded', function() {
    // 支付提醒检查
    checkAndShowPaymentReminders();
    
    // 修改：将待支付倒计时中的minutes替换为分鐘
    function updateCountdownText() {
        const countdownElements = document.querySelectorAll('.countdown-text');
        countdownElements.forEach(element => {
            let text = element.textContent;
            // 替换minutes为分鐘
            text = text.replace(/minutes?/g, '分鐘');
            // 替换minute为分鐘
            text = text.replace(/minute/g, '分鐘');
            element.textContent = text;
        });
    }
    
    // 初始替换
    updateCountdownText();
    
    // 启动制作中订单倒计时
    const preparingCountdown = new PreparingCountdown();
    preparingCountdown.start();
    
    // 每30秒检查一次支付提醒和更新倒计时文本
    setInterval(() => {
        checkAndShowPaymentReminders();
        updateCountdownText();
    }, 30000);
});
</script>

{% endblock %}