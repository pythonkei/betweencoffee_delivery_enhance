# 隊列訂單狀態渲染器中重量選項顯示問題修復報告

## 問題描述
在隊列訂單狀態渲染器中，咖啡商品錯誤地顯示了重量選項，而重量選項應該是咖啡豆專有的屬性。

## 問題根源分析
1. **`get_items_with_chinese_options` 方法**：沒有區分咖啡和咖啡豆的選項處理邏輯
2. **咖啡商品數據**：錯誤地包含了 `weight` 字段
3. **前端顯示**：沒有正確過濾咖啡商品的重量選項

## 修復方案實施

### 1. 修改 `get_items_with_chinese_options` 方法（`eshop/models.py`）
- 添加商品類型判斷邏輯
- 咖啡商品：只處理 `cup_level` 和 `milk_level` 選項，移除 `weight` 字段
- 咖啡豆商品：處理 `grinding_level` 和 `weight` 選項，添加 `weight_cn` 中文顯示
- 添加 `translate_weight` 靜態方法用於重量值的中文轉換

### 2. 修改 `OrderItemProcessor` 類（`eshop/utils/order_item_processor.py`）
- 添加 `_generate_items_options` 方法
- 根據商品類型生成不同的選項顯示
- 咖啡選項：只顯示杯型和牛奶
- 咖啡豆選項：顯示重量和研磨

### 3. 修改 `get_order_display_items` 方法（`eshop/models.py`）
- 更新選項顯示邏輯
- 咖啡項目：使用 `weight_cn` 字段（如果存在）
- 咖啡豆項目：優先使用 `weight_cn`，備用 `weight`

## 修復效果驗證

### 測試結果
1. **翻譯功能測試** ✅
   - `translate_weight` 方法正確轉換重量值
   - `translate_option` 方法正確轉換選項值

2. **方法功能測試** ✅
   - `get_items_with_chinese_options`：咖啡商品不再包含重量字段
   - `get_order_display_items`：選項顯示正確區分商品類型

3. **實際數據驗證** ✅
   - 檢查10個實際訂單：咖啡商品不再顯示重量選項
   - 檢查隊列數據：等待隊列和就緒訂單的選項顯示正確
   - 混合訂單測試：咖啡和咖啡豆的選項顯示正確區分

### 修復效果確認
1. ✅ 咖啡商品不再顯示重量選項
2. ✅ 咖啡豆商品正確顯示重量選項
3. ✅ 重量值正確轉換為中文顯示（200g → 200克，500g → 500克）
4. ✅ 隊列數據中的選項顯示正確
5. ✅ 混合訂單的選項顯示區分正確

## 技術細節

### 新增方法
1. **`translate_weight(weight_value)`**：重量值中文轉換
2. **`_generate_items_options(items)`**：生成項目選項顯示

### 修改邏輯
1. **商品類型判斷**：根據 `item['type']` 區分處理邏輯
2. **重量字段處理**：咖啡商品移除 `weight` 字段，咖啡豆商品保留並轉換
3. **選項顯示構建**：根據商品類型構建不同的選項字符串

## 潛在影響
1. **正向影響**：
   - 提高用戶體驗：選項顯示更準確
   - 減少混淆：咖啡商品不再顯示不相關的重量選項
   - 統一顯示：所有隊列狀態的選項顯示一致

2. **兼容性**：
   - 向後兼容：現有訂單數據不受影響
   - 數據完整性：只影響顯示邏輯，不修改數據庫

## 後續建議
1. **數據清理**：檢查並清理現有訂單中咖啡商品的 `weight` 字段
2. **前端優化**：確保前端模板正確使用新的選項顯示邏輯
3. **監控日誌**：監控 `logger.warning` 輸出，識別異常數據

## 總結
本次修復成功解決了隊列訂單狀態渲染器中重量選項顯示不正確的問題。通過區分咖啡和咖啡豆的商品類型，並針對不同類型應用不同的選項處理邏輯，確保了選項顯示的準確性和用戶體驗的一致性。

**修復完成時間**：2026年2月17日 21:45 (香港時間)
**修復狀態**：✅ 已完成並驗證通過