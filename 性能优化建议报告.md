# å’–å•¡åº—å¤–å¸¦ç½‘ç«™æ€§èƒ½ä¼˜åŒ–å»ºè®®æŠ¥å‘Š

## ğŸ“Š é¡¹ç›®ç°çŠ¶åˆ†æ

åŸºäºå¯¹é¡¹ç›®çš„æ·±å…¥åˆ†æï¼Œç³»ç»Ÿæ•´ä½“æ¶æ„è‰¯å¥½ï¼Œä½†åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æœ‰ä¼˜åŒ–ç©ºé—´ï¼š

### âœ… å·²å®Œæˆçš„ä¼˜åŒ–
1. **ä»£ç æ¸…ç†**ï¼šç§»é™¤äº†æœªä½¿ç”¨çš„å¯¼å…¥ï¼Œå¼€å§‹æ¸…ç†å¼ƒç”¨å­—æ®µ
2. **ç»Ÿä¸€æ—¶é—´æœåŠ¡**ï¼šå·²å®ç° `time_service` ç»Ÿä¸€å¤„ç†é¦™æ¸¯æ—¶åŒº
3. **è®¢å•çŠ¶æ€ç®¡ç†**ï¼šå·²å®ç° `OrderStatusManager` ç»Ÿä¸€ç®¡ç†çŠ¶æ€å˜æ›´
4. **é˜Ÿåˆ—ç®¡ç†**ï¼š`CoffeeQueueManager` å®ç°æ¸…æ™°çš„çŠ¶æ€æœº

### ğŸ” å‘ç°çš„ä¸»è¦é—®é¢˜

## ç¬¬ä¸€éƒ¨åˆ†ï¼šä»£ç ä¼˜åŒ–å»ºè®®

### 1. å¼ƒç”¨å­—æ®µæ¸…ç†ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### 1.1 éœ€è¦æ›¿æ¢çš„å¼ƒç”¨å­—æ®µå¼•ç”¨

**å·²å‘ç°çš„é—®é¢˜ï¼š**
- `order.is_paid` â†’ åº”æ›¿æ¢ä¸º `order.payment_status == 'paid'`
- `order.created_on` â†’ å·²å¼ƒç”¨ï¼Œä½¿ç”¨ `order.created_at`
- `order.cup_size` â†’ å­—æ®µæœªä½¿ç”¨ï¼Œç›´æ¥ç§»é™¤
- `order.pickup_time` â†’ ä½¿ç”¨ `order.estimated_ready_time`

**å…·ä½“ä¿®å¤æ–‡ä»¶ï¼š**
1. `eshop/views/payment_views.py` (3å¤„å¼•ç”¨)
2. `eshop/tests/test_order_comprehensive.py` (1å¤„)
3. `eshop/tests/test_models.py` (2å¤„)
4. `eshop/management/commands/debug_queue.py` (1å¤„)
5. å¤šä¸ªæ¨¡æ¿æ–‡ä»¶ä¸­çš„å¼•ç”¨ï¼ˆéœ€è¦æ‰¹é‡æ›¿æ¢ï¼‰

#### 1.2 ä»£ç è§„èŒƒä¼˜åŒ–

**Flake8 é—®é¢˜ä¿®å¤ï¼š**
- `eshop/views/api_views.py`ï¼šè¡Œè¿‡é•¿é—®é¢˜ã€ç©ºç™½è¡Œé—®é¢˜
- å»ºè®®ä½¿ç”¨ `black` æˆ– `flake8` è‡ªåŠ¨æ ¼å¼åŒ–

### 2. ç±»å‹æç¤ºæ·»åŠ ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**éœ€è¦æ·»åŠ ç±»å‹æç¤ºçš„æ ¸å¿ƒæ–‡ä»¶ï¼š**
1. `eshop/models.py` - æ‰€æœ‰æ¨¡å‹æ–¹æ³•
2. `eshop/order_status_manager.py` - æ ¸å¿ƒçŠ¶æ€ç®¡ç†ç±»
3. `eshop/queue_manager.py` - é˜Ÿåˆ—ç®¡ç†ç±»
4. `eshop/time_service.py` - æ—¶é—´æœåŠ¡ç±»

**ç¤ºä¾‹æ”¹è¿›ï¼š**
```python
# ä¹‹å‰
def get_order(self, order_id):
    # ...

# ä¹‹å  
def get_order(self, order_id: int) -> OrderModel:
    # ...
```

## ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®åº“ä¼˜åŒ–å»ºè®®

### 1. å½“å‰ç´¢å¼•çŠ¶æ€åˆ†æ

æ ¹æ®æ•°æ®åº“ç´¢å¼•åˆ†æï¼Œå½“å‰ç´¢å¼•é…ç½®è‰¯å¥½ï¼š

#### 1.1 OrderModel è¡¨ç´¢å¼•ï¼ˆ9ä¸ªç´¢å¼•ï¼‰
âœ… **è‰¯å¥½é…ç½®ï¼š**
- `eshop_order_payment_2065e3_idx` (payment_status, payment_timeout)
- `eshop_order_created_492eca_idx` (created_at, payment_status)
- `eshop_order_user_id_3cdada_idx` (user_id, payment_status)
- `eshop_order_status_760184_idx` (status, updated_at)

#### 1.2 CoffeeQueue è¡¨ç´¢å¼•ï¼ˆ4ä¸ªç´¢å¼•ï¼‰
âœ… **è‰¯å¥½é…ç½®ï¼š**
- `eshop_coffe_status_212322_idx` (status, position)
- `eshop_coffe_estimat_548772_idx` (estimated_completion_time)

### 2. å»ºè®®æ·»åŠ çš„ç´¢å¼•ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

#### 2.1 ç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢çš„ç´¢å¼•
```sql
-- ç”¨äºå¿«é€ŸæŸ¥æ‰¾å³å°†åˆ°æœŸçš„æ”¯ä»˜
CREATE INDEX idx_order_payment_timeout ON eshop_ordermodel (payment_timeout) 
WHERE payment_status = 'pending';

-- ç”¨äºæŸ¥æ‰¾éœ€è¦åˆ¶ä½œçš„è®¢å•
CREATE INDEX idx_order_ready_time ON eshop_ordermodel (estimated_ready_time) 
WHERE status IN ('waiting', 'preparing');
```

#### 2.2 ç”¨äºç»Ÿè®¡æŸ¥è¯¢çš„ç´¢å¼•
```sql
-- æ¯æ—¥é”€å”®ç»Ÿè®¡ä¼˜åŒ–
CREATE INDEX idx_order_created_date ON eshop_ordermodel 
(date(created_at), payment_status);
```

### 3. æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

#### 3.1 å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼åˆ†æ
1. **æ´»è·ƒè®¢å•æŸ¥è¯¢**ï¼š`status IN ('preparing', 'ready') AND payment_status = 'paid'`
2. **å¾…æ”¯ä»˜è®¢å•æŸ¥è¯¢**ï¼š`payment_status = 'pending' AND payment_timeout > NOW()`
3. **é˜Ÿåˆ—æŸ¥è¯¢**ï¼š`status = 'waiting' ORDER BY position`

#### 3.2 Django ORM ä¼˜åŒ–
```python
# ä¼˜åŒ–å‰
orders = OrderModel.objects.filter(payment_status='paid')
for order in orders:
    items = order.get_items()  # æ¯æ¬¡è°ƒç”¨éƒ½è§£æJSON

# ä¼˜åŒ–å - æ‰¹é‡å¤„ç†
orders = OrderModel.objects.filter(payment_status='paid').only('id', 'items')
# ä¸€æ¬¡æ€§è§£ææ‰€æœ‰items
```

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶æ„ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

#### 1.1 Redis ç¼“å­˜åº”ç”¨
```python
# é˜Ÿåˆ—çŠ¶æ€ç¼“å­˜
CACHE_KEYS = {
    'queue_summary': 'queue:summary',
    'active_orders': 'orders:active',
    'quick_order_times': 'times:quick',
}

# ä½¿ç”¨ django-redis ç¼“å­˜
from django.core.cache import cache

def get_queue_summary_cached():
    key = CACHE_KEYS['queue_summary']
    summary = cache.get(key)
    if summary is None:
        summary = calculate_queue_summary()
        cache.set(key, summary, timeout=30)  # 30ç§’ç¼“å­˜
    return summary
```

#### 1.2 æŸ¥è¯¢ç»“æœç¼“å­˜
- é¦–é¡µçƒ­é—¨å•†å“ï¼šç¼“å­˜5åˆ†é’Ÿ
- é˜Ÿåˆ—ç»Ÿè®¡ï¼šç¼“å­˜30ç§’
- è®¢å•è¯¦æƒ…ï¼šåŸºäºè®¢å•IDç¼“å­˜

### 2. WebSocket è¿æ¥ä¼˜åŒ–

#### 2.1 å½“å‰çŠ¶æ€
- âœ… å·²å®ç°å¿ƒè·³æœºåˆ¶
- âœ… å·²å®ç°é‡è¿é€»è¾‘
- âœ… è¿æ¥ç®¡ç†è‰¯å¥½

#### 2.2 ä¼˜åŒ–å»ºè®®
1. **è¿æ¥æ± ç®¡ç†**ï¼šé™åˆ¶æœ€å¤§è¿æ¥æ•°ï¼Œé¿å…èµ„æºè€—å°½
2. **æ¶ˆæ¯æ‰¹å¤„ç†**ï¼šå°†å¤šä¸ªæ›´æ–°åˆå¹¶ä¸ºå•ä¸ªæ¶ˆæ¯å‘é€
3. **æ–­çº¿é‡è¿ä¼˜åŒ–**ï¼šå®ç°æŒ‡æ•°é€€é¿ç®—æ³•

### 3. å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### 3.1 JavaScript æ¨¡å—åŒ–
```javascript
// å½“å‰ï¼šå¤šä¸ªç‹¬ç«‹æ–‡ä»¶
// å»ºè®®ï¼šES6æ¨¡å—é‡æ„
import { WebSocketManager } from './websocket-manager.js';
import { QueueManager } from './queue-manager.js';
import { TimeUtils } from './time-utils.js';
```

#### 3.2 èµ„æºåŠ è½½ä¼˜åŒ–
1. **ä»£ç åˆ†å‰²**ï¼šæŒ‰éœ€åŠ è½½å‘˜å·¥ç«¯å’Œé¡¾å®¢ç«¯ä»£ç 
2. **å›¾ç‰‡ä¼˜åŒ–**ï¼šä½¿ç”¨WebPæ ¼å¼ï¼Œå®ç°æ‡’åŠ è½½
3. **CSSä¼˜åŒ–**ï¼šæå–å…¬å…±æ ·å¼ï¼Œå‡å°‘é‡å¤

## ç¬¬å››éƒ¨åˆ†ï¼šç›‘æ§ä¸ç»´æŠ¤å»ºè®®

### 1. æ€§èƒ½ç›‘æ§æŒ‡æ ‡

#### 1.1 åŸºç¡€æŒ‡æ ‡
- å¹³å‡å“åº”æ—¶é—´ < 200ms
- 99%å“åº”æ—¶é—´ < 1s
- é”™è¯¯ç‡ < 0.1%
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡ < 80%

#### 1.2 ä¸šåŠ¡æŒ‡æ ‡
- è®¢å•å¤„ç†æ—¶é—´ï¼šä»æ”¯ä»˜åˆ°å®Œæˆ
- é˜Ÿåˆ—ç­‰å¾…æ—¶é—´ï¼šå¹³å‡ç­‰å¾…æ—¶é—´
- æ”¯ä»˜æˆåŠŸç‡ï¼šæ”¯ä»˜æˆåŠŸç‡ç»Ÿè®¡

### 2. æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–

#### 2.1 ç»“æ„åŒ–æ—¥å¿—
```python
import structlog

logger = structlog.get_logger()

# ç»“æ„åŒ–æ—¥å¿—
logger.info("order_status_changed", 
    order_id=order.id,
    old_status=old_status,
    new_status=new_status,
    user_id=request.user.id if request.user else None
)
```

#### 2.2 æ—¥å¿—çº§åˆ«é…ç½®
- ERRORï¼šç³»ç»Ÿé”™è¯¯ã€æ”¯ä»˜å¤±è´¥
- WARNINGï¼šé˜Ÿåˆ—ç§¯å‹ã€æ—¶é—´å»¶è¿Ÿ
- INFOï¼šçŠ¶æ€å˜æ›´ã€ç”¨æˆ·æ“ä½œ
- DEBUGï¼šå¼€å‘è°ƒè¯•

### 3. å¥åº·æ£€æŸ¥ç«¯ç‚¹

#### 3.1 åŸºæœ¬å¥åº·æ£€æŸ¥
```python
@csrf_exempt
@require_GET
def health_check(request):
    """ç³»ç»Ÿå¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    checks = {
        'database': check_database_connection(),
        'redis': check_redis_connection(),
        'websocket': check_websocket_connections(),
        'queue_status': get_queue_health_status(),
    }
    
    status = 200 if all(checks.values()) else 503
    return JsonResponse({
        'status': 'healthy' if status == 200 else 'unhealthy',
        'timestamp': timezone.now().isoformat(),
        'checks': checks
    }, status=status)
```

## ç¬¬äº”éƒ¨åˆ†ï¼šå®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šç«‹å³å®æ–½ï¼ˆ1-2å¤©ï¼‰
1. **å¼ƒç”¨å­—æ®µæ¸…ç†**ï¼šæ‰¹é‡æ›¿æ¢ `is_paid` ç­‰å­—æ®µå¼•ç”¨
2. **ä»£ç è§„èŒƒä¿®å¤**ï¼šä¿®å¤ `api_views.py` çš„Flake8é—®é¢˜
3. **åŸºç¡€ç›‘æ§æ·»åŠ **ï¼šæ·»åŠ ç®€å•å¥åº·æ£€æŸ¥ç«¯ç‚¹

### ç¬¬äºŒé˜¶æ®µï¼šçŸ­æœŸä¼˜åŒ–ï¼ˆ3-7å¤©ï¼‰
1. **ç±»å‹æç¤ºæ·»åŠ **ï¼šä¸ºæ ¸å¿ƒæ–‡ä»¶æ·»åŠ ç±»å‹æç¤º
2. **ç¼“å­˜ç­–ç•¥å®ç°**ï¼šå®ç°Redisç¼“å­˜ç­–ç•¥
3. **æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–**ï¼šæ·»åŠ ç»“æ„åŒ–æ—¥å¿—

### ç¬¬ä¸‰é˜¶æ®µï¼šä¸­æœŸä¼˜åŒ–ï¼ˆ2-4å‘¨ï¼‰
1. **å‰ç«¯é‡æ„**ï¼šJavaScriptæ¨¡å—åŒ–é‡æ„
2. **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**ï¼šæ·»åŠ ç¼ºå¤±ç´¢å¼•
3. **æ€§èƒ½ç›‘æ§**ï¼šæ·»åŠ è¯¦ç»†æ€§èƒ½æŒ‡æ ‡

### ç¬¬å››é˜¶æ®µï¼šé•¿æœŸè§„åˆ’ï¼ˆ1-3ä¸ªæœˆï¼‰
1. **å¾®æœåŠ¡æ‹†åˆ†**ï¼šè€ƒè™‘å°†æ”¯ä»˜ã€é˜Ÿåˆ—ã€é€šçŸ¥æ‹†åˆ†ä¸ºç‹¬ç«‹æœåŠ¡
2. **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDockerå®¹å™¨åŒ–éƒ¨ç½²
3. **CI/CDæµæ°´çº¿**ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²

## ç¬¬å…­éƒ¨åˆ†ï¼šé£é™©è¯„ä¼°

### ä½é£é™©ä¼˜åŒ–
- ä»£ç è§„èŒƒä¿®å¤
- ç±»å‹æç¤ºæ·»åŠ 
- æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–

### ä¸­é£é™©ä¼˜åŒ–
- å¼ƒç”¨å­—æ®µæ¸…ç†ï¼ˆéœ€è¦å…¨é¢æµ‹è¯•ï¼‰
- æ•°æ®åº“ç´¢å¼•è°ƒæ•´ï¼ˆéœ€è¦æµ‹è¯•æ€§èƒ½å½±å“ï¼‰
- ç¼“å­˜ç­–ç•¥å®ç°ï¼ˆå¯èƒ½å¼•å…¥ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼‰

### é«˜é£é™©ä¼˜åŒ–
- æ¶æ„é‡æ„
- æ•°æ®åº“schemaå˜æ›´
- ç¬¬ä¸‰æ–¹ä¾èµ–å‡çº§

## æ€»ç»“

æœ¬é¡¹ç›®æ•´ä½“æ¶æ„è‰¯å¥½ï¼Œ95%åŠŸèƒ½è¿è¡Œæ­£å¸¸ç¨³å®šã€‚ä¸»è¦ä¼˜åŒ–æ–¹å‘é›†ä¸­åœ¨ï¼š

1. **ä»£ç è´¨é‡**ï¼šæ¸…ç†æŠ€æœ¯å€ºåŠ¡ï¼Œæé«˜å¯ç»´æŠ¤æ€§
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡ç¼“å­˜å’Œç´¢å¼•æå‡å“åº”é€Ÿåº¦
3. **ç›‘æ§è¿ç»´**ï¼šæ·»åŠ ç›‘æ§å’Œæ—¥å¿—ï¼Œæé«˜ç³»ç»Ÿå¯é æ€§

å»ºè®®æŒ‰é˜¶æ®µé€æ­¥å®æ–½ï¼Œæ¯å®Œæˆä¸€ä¸ªé˜¶æ®µéƒ½è¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œç¡®ä¿ä¸å½±å“ç°æœ‰åŠŸèƒ½çš„ç¨³å®šæ€§ã€‚