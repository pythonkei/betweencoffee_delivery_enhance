{% extends 'layouts/blank.html' %}
{% load static %}

{% block content %}
<section class="ftco-section-blank-small"></section>

<section class="ftco-subpage-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">支付状态检查</h4>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <i class="fas fa-search-dollar fa-3x text-primary mb-3"></i>
                            <h5>订单号: #{{ order.id }}</h5>
                            <p class="text-muted">总金额: HK$ {{ order.total_price|floatformat:2 }}</p>
                        </div>

                        <div class="alert alert-info">
                            <h6>当前状态:</h6>
                            <p>
                                {% if order.is_paid %}
                                    <span class="badge badge-success">已支付</span>
                                {% else %}
                                    <span class="badge badge-warning">待支付</span>
                                {% endif %}
                            </p>
                            <small>如果支付宝已扣款但状态未更新，请点击下方按钮手动更新</small>
                        </div>

                        <div class="d-grid gap-2">
                            <button id="check-status-btn" class="btn btn-primary">
                                <i class="fas fa-sync-alt mr-2"></i>检查支付状态
                            </button>
                            <a href="{% url 'eshop:order_payment_confirmation' %}?order_id={{ order.id }}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-receipt mr-2"></i>查看订单详情
                            </a>
                            <a href="{% url 'index' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-home mr-2"></i>返回首页
                            </a>
                        </div>

                        <div id="status-result" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('check-status-btn').addEventListener('click', function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>检查中...';
    btn.disabled = true;
    
    fetch(`/eshop/check_order_status/{{ order.id }}/`)
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('status-result');
            
            if (data.is_paid) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle mr-2"></i>
                        支付状态已更新！订单已确认支付。
                    </div>
                `;
                // 3秒后自动跳转
                setTimeout(() => {
                    window.location.href = "{% url 'eshop:order_payment_confirmation' %}?order_id={{ order.id }}";
                }, 3000);
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        订单尚未支付，请完成支付流程。
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
        })
        .catch(error => {
            document.getElementById('status-result').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle mr-2"></i>
                    检查失败，请稍后重试或联系客服。
                </div>
            `;
            document.getElementById('status-result').style.display = 'block';
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
});
</script>
{% endblock %}