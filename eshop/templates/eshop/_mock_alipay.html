{% extends 'betweencoffee_delivery/base.html' %}
{% load static %}

{% block content %}
<section class="ftco-section-blank"></section>

<!-- subheader-->
<section class="ftco-subpage-section">
    <div class="container">
        <div class="row justify-content-center align-items-center">
            <div class="col-lg-12 col-md-7 col-sm-12 text-center">
                <h1 class="mt-5 bread">Alipay HK 付款</h1>
            </div>
        </div>
    </div>
</section>
<!-- end subheader-->

<section class="ftco-section">
    <div class="container">
        <div class="card-body">
        <div class="text-center">
            <div>
                <p>Order #{{ order_id }} | Amount: HK$ {{ order.total_price|floatformat:2 }}</p>
            </div>

            <img src="data:image/png;base64,{{ qr_img }}" 
                class="img-fluid mb-4" 
                style="max-width: 200px;"
                alt="Dynamic QR Code">
            
            <form method="POST" action="{% url 'eshop:mock_alipay_callback' %}" id="mock-payment-form">
            {% csrf_token %}
            <input type="hidden" name="out_trade_no" value="{{ order_id }}">
            <input type="hidden" name="total_amount" value="{{ order.total_price }}">
            
            <div class="btn-group">
                <button type="submit" name="status" value="success" 
                        class="btn btn-success btn-lg">
                Simulate Success
                </button>
                <button type="submit" name="status" value="failed" 
                        class="btn btn-danger btn-lg">
                Simulate Failure
                </button>
            </div>
            </form>
            
        <!-- Response display area -->
        <div id="payment-response" class="mt-4" style="min-height: 100px;"></div>
        </div>
        </div>
        
        <div hidden class="card-footer text-muted">
        <small>Development Mode - Not real payment</small>
        </div>
    </div>
    </div>
</section>


<script>
document.getElementById('mock-payment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const responseDiv = document.getElementById('payment-response');
    
    responseDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Processing payment...</p></div>';
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Handle both success and failure responses
        if (response.ok) {
            return response.json().then(data => {
                // Success case
                responseDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>Payment Successful!</h4>
                        <p>Order #${data.out_trade_no} - HK$${data.total_amount}</p>
                        <p>${data.msg}</p>
                        <a href="{% url 'eshop:order_payment_confirmation' %}" class="btn btn-success">
                            View Order Confirmation
                        </a>
                    </div>
                `;
            });
        } else {
            return response.json().then(data => {
                // Failure case
                responseDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Payment Failed!</h4>
                        <p>Error: ${data.msg}</p>
                        <p>Code: ${data.code}</p>
                        <p>${data.sub_msg || ''}</p>
                        <button class="btn btn-warning" onclick="location.reload()">
                            Try Again
                        </button>
                    </div>
                `;
            });
        }
    })
    .catch(error => {
        // Network or parsing error
        responseDiv.innerHTML = `
            <div class="alert alert-danger">
                <h4>Error Occurred</h4>
                <p>${error.message}</p>
            </div>
        `;
    });
});
</script>


{% endblock %}