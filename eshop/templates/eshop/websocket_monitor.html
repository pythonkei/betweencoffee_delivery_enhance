{# templates/admin/websocket_monitor.html #}
{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}WebSocket ç›£æ§å„€è¡¨æ¿{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<style>
    .stat-card {
        border-radius: 10px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }
    .stat-card:hover {
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    .stat-value {
        font-size: 2.5rem;
        font-weight: 600;
        line-height: 1.2;
    }
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .connection-item {
        transition: background-color 0.2s;
    }
    .connection-item:hover {
        background-color: #f8f9fa;
    }
    .badge-connection {
        font-size: 0.8rem;
        padding: 5px 10px;
    }
    #chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">
        <i class="fas fa-plug mr-2"></i>WebSocket å³æ™‚ç›£æ§
        <small class="text-muted ml-2" style="font-size: 0.9rem;">ç®¡ç†å“¡å°ˆç”¨</small>
    </h1>

    <!-- é ‚éƒ¨å·¥å…·åˆ— -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <button id="refresh-stats" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt mr-1"></i>æ‰‹å‹•åˆ·æ–°
            </button>
            <span id="auto-refresh-badge" class="ml-2 badge badge-light">
                <i class="fas fa-clock mr-1"></i>è‡ªå‹•åˆ·æ–°: 5ç§’
            </span>
        </div>
        <div>
            <button id="reset-stats-btn" class="btn btn-outline-danger">
                <i class="fas fa-trash-alt mr-1"></i>é‡ç½®çµ±è¨ˆ
            </button>
        </div>
    </div>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-label">æ´»èºé€£ç·š</div>
                            <div id="stat-active" class="stat-value">0</div>
                        </div>
                        <div class="text-primary">
                            <i class="fas fa-users fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-label">å“¡å·¥é€£ç·š</div>
                            <div id="stat-staff" class="stat-value">0</div>
                        </div>
                        <div class="text-info">
                            <i class="fas fa-user-tie fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-label">é¡§å®¢é€£ç·š</div>
                            <div id="stat-customer" class="stat-value">0</div>
                        </div>
                        <div class="text-success">
                            <i class="fas fa-user fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-label">ç´¯ç©è¨Šæ¯</div>
                            <div id="stat-messages" class="stat-value">0</div>
                        </div>
                        <div class="text-warning">
                            <i class="fas fa-envelope fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åœ–è¡¨å€å¡Š + é€£ç·šåˆ—è¡¨ -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line mr-2"></i>é€£ç·šæ•¸è¶¨å‹¢ï¼ˆæœ€è¿‘5åˆ†é˜ï¼‰</h5>
                </div>
                <div class="card-body">
                    <div id="chart-container">
                        <canvas id="connection-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list-ul mr-2"></i>ç›®å‰é€£ç·š</h5>
                    <div>
                        <label class="mr-2">
                            <input type="checkbox" id="filter-staff-only" class="mr-1"> åƒ…é¡¯ç¤ºå“¡å·¥
                        </label>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="connection-list-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>ID</th>
                                    <th>é¡å‹</th>
                                    <th>ä½¿ç”¨è€…</th>
                                    <th>é€£ç·šæ™‚é–“</th>
                                    <th>æœ€å¾Œæ´»å‹•</th>
                                </tr>
                            </thead>
                            <tbody id="connection-table-body">
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin mr-1"></i>è¼‰å…¥ä¸­...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <span id="connection-count-badge" class="badge badge-secondary">0 å€‹é€£ç·š</span>
                        <button id="refresh-connections-btn" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-redo-alt mr-1"></i>åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç³»çµ±å»£æ’­å·¥å…· -->
    <div class="row mt-2">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-bullhorn mr-2"></i>ç³»çµ±å»£æ’­</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <div class="input-group">
                            <input type="text" id="broadcast-message" class="form-control" 
                                   placeholder="è¼¸å…¥å»£æ’­è¨Šæ¯..." maxlength="200">
                            <div class="input-group-append">
                                <select id="broadcast-type" class="custom-select" style="max-width: 120px;">
                                    <option value="info">è³‡è¨Š</option>
                                    <option value="warning">è­¦å‘Š</option>
                                    <option value="success">æˆåŠŸ</option>
                                </select>
                                <button id="send-broadcast-btn" class="btn btn-primary">
                                    <i class="fas fa-paper-plane mr-1"></i>ç™¼é€
                                </button>
                                <button id="broadcast-test-btn" class="btn btn-outline-secondary">
                                    <i class="fas fa-vial mr-1"></i>æ¸¬è©¦å»£æ’­
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="broadcast-history" class="small text-muted">
                        <span>ğŸ“‹ æœ€è¿‘å»£æ’­ï¼š</span><span id="last-broadcast">ç„¡</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script>
    // WebSocket ç›£æ§å„€è¡¨æ¿æ§åˆ¶å™¨
    class WebSocketMonitor {
        constructor() {
            this.stats = { active_connections: 0, staff_connections: 0, customer_connections: 0, total_messages: 0 };
            this.connections = [];
            this.chart = null;
            this.chartData = {
                labels: [],
                active: [],
                staff: [],
                customer: []
            };
            this.autoRefreshInterval = null;
            this.init();
        }

        init() {
            this.loadStats();
            this.loadConnections();
            this.initChart();
            this.bindEvents();
            this.startAutoRefresh(5000); // 5ç§’
        }

        // ====== API å‘¼å« ======
        async fetchAPI(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`âŒ API éŒ¯èª¤ (${url}):`, error);
                throw error;
            }
        }

        async loadStats() {
            try {
                const data = await this.fetchAPI('/eshop/api/websocket/stats/');
                if (data.success) {
                    // âœ… ä¿®æ­£ï¼šstats åœ¨ data.stats ä¸­ï¼Œä¸æ˜¯ data.data
                    this.stats = data.stats.summary;   // æ ¹æ“š websocket_manager.get_stats() çµæ§‹
                    this.updateStatsUI();
                    this.addChartDataPoint();
                }
            } catch (error) {
                this.showToast('ç²å–çµ±è¨ˆå¤±æ•—', 'error');
            }
        }

        async loadConnections(onlyStaff = false) {
            try {
                let url = '/eshop/api/websocket/connections/';
                if (onlyStaff) url += '?user_type=staff';
                const data = await this.fetchAPI(url);
                if (data.success) {
                    // âœ… ä¿®æ­£ï¼šconnections åœ¨ data.connections
                    this.connections = data.connections || [];
                    this.renderConnections();
                }
            } catch (error) {
                this.showToast('ç²å–é€£ç·šåˆ—è¡¨å¤±æ•—', 'error');
            }
        }

        async resetStats() {
            if (!confirm('ç¢ºå®šé‡ç½®æ‰€æœ‰çµ±è¨ˆæ•¸æ“šï¼Ÿ')) return;
            try {
                const data = await this.fetchAPI('/eshop/api/websocket/reset-stats/', {
                    method: 'POST'
                });
                if (data.success) {
                    this.showToast('çµ±è¨ˆå·²é‡ç½®', 'success');
                    this.loadStats();
                    this.loadConnections();
                }
            } catch (error) {
                this.showToast('é‡ç½®å¤±æ•—', 'error');
            }
        }

        async sendBroadcast(message, type = 'info') {
            if (!message.trim()) {
                this.showToast('è«‹è¼¸å…¥è¨Šæ¯', 'warning');
                return;
            }
            try {
                const data = await this.fetchAPI('/eshop/api/websocket/broadcast-test/', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        message: message,
                        message_type: type 
                    })
                });
                if (data.success) {
                    // âœ… ä¿®æ­£ï¼šrecipient_count åœ¨ data.data.recipient_count
                    const count = data.data?.recipient_count || 0;
                    this.showToast(`âœ… å»£æ’­å·²ç™¼é€ (${count} å€‹é€£ç·š)`, 'success');
                    document.getElementById('last-broadcast').innerText = `${message} (${new Date().toLocaleTimeString()})`;
                    document.getElementById('broadcast-message').value = '';
                }
            } catch (error) {
                this.showToast('å»£æ’­ç™¼é€å¤±æ•—', 'error');
            }
        }

        async broadcastTest() {
            try {
                const data = await this.fetchAPI('/eshop/api/websocket/broadcast-test/');
                if (data.success) {
                    const count = data.data?.recipient_count || 0;
                    this.showToast(`âœ… æ¸¬è©¦å»£æ’­å·²ç™¼é€ (${count} å€‹é€£ç·š)`, 'success');
                    document.getElementById('last-broadcast').innerText = `æ¸¬è©¦å»£æ’­ (${new Date().toLocaleTimeString()})`;
                }
            } catch (error) {
                this.showToast('æ¸¬è©¦å»£æ’­å¤±æ•—', 'error');
            }
        }

        // ====== UI æ›´æ–° ======
        updateStatsUI() {
            document.getElementById('stat-active').innerText = this.stats.active_connections || 0;
            // æ³¨æ„ï¼šstaff_connections èˆ‡ customer_connections ä¸åœ¨ summary ä¸­ï¼Œéœ€è¦å¦å¤–è¨ˆç®—
            // æˆ‘å€‘å¯ä»¥å¾ this.connections å³æ™‚è¨ˆç®—ï¼Œæˆ–å¾ŒçºŒæ“´å…… API
            // æš«æ™‚å…ˆè¨­ç‚º 0ï¼Œä½†å¯å¾ this.connections éæ¿¾
            const staffCount = this.connections.filter(c => c.user_type === 'staff').length;
            const customerCount = this.connections.filter(c => c.user_type === 'customer').length;
            document.getElementById('stat-staff').innerText = staffCount;
            document.getElementById('stat-customer').innerText = customerCount;
            document.getElementById('stat-messages').innerText = this.stats.messages_sent || 0;
            document.getElementById('connection-count-badge').innerText = `${this.connections.length} å€‹é€£ç·š`;
        }

        renderConnections() {
            const tbody = document.getElementById('connection-table-body');
            if (!this.connections || this.connections.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">ç›®å‰ç„¡æ´»å‹•é€£ç·š</td></tr>`;
                return;
            }

            let html = '';
            this.connections.forEach(conn => {
                const userType = conn.user_type || 'unknown';
                const userTypeClass = userType === 'staff' ? 'badge-primary' : 'badge-info';
                const userTypeText = userType === 'staff' ? 'å“¡å·¥' : (userType === 'customer' ? 'é¡§å®¢' : 'å…¶ä»–');
                
                html += `<tr class="connection-item">
                    <td><small>${conn.connection_id?.substring(0, 8) || '-'}</small></td>
                    <td><span class="badge ${userTypeClass} badge-pill">${userTypeText}</span></td>
                    <td>${conn.username || conn.user_id || 'åŒ¿å'}</td>
                    <td><small>${this.formatTime(conn.connected_at)}</small></td>
                    <td><small>${this.formatTime(conn.last_activity)}</small></td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        // ====== åœ–è¡¨ ======
        initChart() {
            const ctx = document.getElementById('connection-chart').getContext('2d');
            this.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: this.chartData.labels,
                    datasets: [
                        {
                            label: 'ç¸½é€£ç·š',
                            data: this.chartData.active,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0,123,255,0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'å“¡å·¥',
                            data: this.chartData.staff,
                            borderColor: '#17a2b8',
                            backgroundColor: 'rgba(23,162,184,0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'é¡§å®¢',
                            data: this.chartData.customer,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40,167,69,0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            });
        }

        addChartDataPoint() {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            this.chartData.labels.push(timeLabel);
            this.chartData.active.push(this.stats.active_connections || 0);
            this.chartData.staff.push(this.stats.staff_connections || 0);
            this.chartData.customer.push(this.stats.customer_connections || 0);

            // ä¿ç•™æœ€è¿‘20å€‹é»
            if (this.chartData.labels.length > 20) {
                this.chartData.labels.shift();
                this.chartData.active.shift();
                this.chartData.staff.shift();
                this.chartData.customer.shift();
            }

            if (this.chart) {
                this.chart.update();
            }
        }

        // ====== è‡ªå‹•åˆ·æ–° ======
        startAutoRefresh(ms) {
            if (this.autoRefreshInterval) clearInterval(this.autoRefreshInterval);
            this.autoRefreshInterval = setInterval(() => {
                this.loadStats();
                if (document.getElementById('filter-staff-only').checked) {
                    this.loadConnections(true);
                } else {
                    this.loadConnections();
                }
            }, ms);
        }

        // ====== äº‹ä»¶ç¶å®š ======
        bindEvents() {
            document.getElementById('refresh-stats').addEventListener('click', () => {
                this.loadStats();
                this.loadConnections();
            });

            document.getElementById('refresh-connections-btn').addEventListener('click', () => {
                const onlyStaff = document.getElementById('filter-staff-only').checked;
                this.loadConnections(onlyStaff);
            });

            document.getElementById('filter-staff-only').addEventListener('change', (e) => {
                this.loadConnections(e.target.checked);
            });

            document.getElementById('reset-stats-btn').addEventListener('click', () => this.resetStats());
            document.getElementById('send-broadcast-btn').addEventListener('click', () => {
                const msg = document.getElementById('broadcast-message').value;
                const type = document.getElementById('broadcast-type').value;
                this.sendBroadcast(msg, type);
            });
            document.getElementById('broadcast-test-btn').addEventListener('click', () => this.broadcastTest());
        }

        // ====== è¼”åŠ© ======
        formatTime(isoString) {
            if (!isoString) return '--';
            try {
                const date = new Date(isoString);
                return date.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } catch {
                return isoString;
            }
        }

        showToast(message, type = 'info') {
            // ç°¡å–® alertï¼Œå¯æ›¿æ›ç‚ºæ¼‚äº® toast
            alert(`[${type.toUpperCase()}] ${message}`);
        }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        window.wsMonitor = new WebSocketMonitor();
    });
</script>
{% endblock %}