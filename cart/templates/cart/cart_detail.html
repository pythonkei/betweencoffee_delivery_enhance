<!-- cart/templates/cart/cart_detail.html -->
{% extends 'layouts/blank.html' %}
{% load static %}
{% block title %}Between Coffee - Cart{% endblock %}

{% block content %}

<section class="ftco-section-blank-small"></section>


<!-- subpage Header-->
<section class="ftco-subpage-section">
    <div class="container">
        <div class="row justify-content-center align-items-center">
            <span class="title-bg-head">&#65371;Enjoy&#65373;</span>
            <div class="col-lg-12 col-md-12 col-sm-12">
                <p class="cart-head d-flex mb-3 mt-5">
                    <span class="h1"></span>
                    <span class="text-right">
                    <a href="{% url 'coffee_menu' %}"><i class="icon material-symbols-outlined">undo</i> 繼續購物</a>
            </span>
                </p>
            </div>
        </div>
    </div>
</section>
<!-- end subpage header-->


<!-- Cart Item Section - Render for loop-->
{% if cart %}
<section class="ftco-cart">
    <div class="container">
        <div class="cart__items">
            <!-- cart item table -->
            <table class="cart-items">
                <caption hidden class="visually-hidden small-hide">購物車</caption>
                <thead>
                    <tr>
                        <th class="caption-with-letter-spacing" colspan="2" scope="col">商品</th>
                        <th class="large-up-hide right caption-with-letter-spacing" colspan="1" scope="col">合計</th>
                        <th class="cart-items__heading--wide cart-items__heading--quantity small-hide caption-with-letter-spacing" colspan="1" scope="col">数量</th>
                        <th class="small-hide right caption-with-letter-spacing" colspan="1" scope="col">合計</th>
                    </tr>
                </thead>

                <tbody>
                {% for item in cart %}
                    <tr class="cart-item">
                    <td class="cart-item__media">
                        <div class="cart-item__image-container cart-item__image__cut-white-space">
                            <a href="{% if item.type == 'coffee' %}{% url 'coffee' item.product_id %}{% else %}{% url 'bean' item.product_id %}{% endif %}" 
                            class="cart-item__name cart-list break"><img src="{{ item.image }}" class="cart-item__image" alt="item.image">
                            </a>
                        </div>
                    </td>

                    <td class="cart-item__details">
                        <a href="" class="cart-item__name cart-list break">
                            <p hidden>
                                {% if item.type == 'coffee' %}- 咖啡 -
                                {% elif item.type == 'bean' %}- 咖啡豆 -
                                {% endif %}
                            </p>
                            <a href="{% if item.type == 'coffee' %}{% url 'coffee' item.product_id %}{% else %}{% url 'bean' item.product_id %}{% endif %}" 
                            class="cart-item__name cart-list break">
                                <h5>{{ item.name }}</h5>
                            </a>
                            <div class="cart-option">
                                ${{ item.price|floatformat:0 }}
                            </div>
                        <div class="cart-option-2">
                            {% if item.type == 'coffee' %}
                                <p>
                                    <i class="icon material-symbols-outlined">water_full</i>
                                    杯量 : 
                                    <strong>
                                    {% if item.cup_level == 'Small' %}細
                                    {% elif item.cup_level == 'Medium' %}中
                                    {% elif item.cup_level == 'Large' %}大
                                    {% endif %}
                                    </strong>
                                    <br>
                                    <i class="icon material-symbols-outlined">humidity_mid</i>
                                    奶量 :
                                    <strong>
                                    {% if item.milk_level == 'Light' %}少
                                    {% elif item.milk_level == 'Medium' %}正常
                                    {% elif item.milk_level == 'Extra' %}追加
                                    {% endif %}
                                    </strong>
                                </p>
                            {% elif item.type == 'bean' %}
                                <!-- ✅ 優化：咖啡豆選項顯示結構與咖啡一致 -->
                                <p>
                                    <i class="icon material-symbols-outlined">roller_shades</i>
                                    研磨 :
                                    <strong>
                                    {% if item.grinding_level == 'Non' %}免研磨
                                    {% elif item.grinding_level == 'Light' %}細
                                    {% elif item.grinding_level == 'Medium' %}中
                                    {% elif item.grinding_level == 'Deep' %}粗
                                    {% endif %}
                                    </strong>
                                    <br>
                                    <i class="icon material-symbols-outlined">scale</i>
                                    重量 :
                                    <strong>
                                    {% if item.weight == '200g' %}200g
                                    {% elif item.weight == '500g' %}500g
                                    {% elif item.weight == '1kg' %}500g  <!-- ✅ 兼容舊數據：將1kg顯示為500g -->
                                    {% else %}{{ item.weight|default:"200g" }}  <!-- ✅ 顯示實際值 -->
                                    {% endif %}
                                    </strong>
                                </p>
                            {% endif %}
                        </div>
                        <dl></dl>
                        <p class="product-option"></p>
                    </td>

<!-- 單項總價顯示 - 移動端 -->
<td class="cart-item__totals right large-up-hide">
    <div class="cart-item__price-wrapper">
        <span class="cart-item__final-price item-total">
            ${{ item.total_price }}
        </span>
    </div>
</td>

                    <td class="cart-item__quantity">
                        <quantity-popover>
                            <div class="cart-item__quantity-wrapper quantity-popover-wrapper">
                                <div class="cart-item-quantity">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <button type="button" class="quantity-right-plus btn" data-type="plus" data-field="">
                                                    <i class="icon-plus"></i>
                                                </button>
                                            </span>
                                                <input 
                                                class="form-control quantity-input" 
                                                value="{{ item.quantity }}" 
                                                min="1" 
                                                data-item-key="{{ item.item_id }}" 
                                                data-item-price="{{ item.price }}"  
                                                >
                                            <span class="input-group-btn">
                                                <button type="button" class="quantity-left-minus btn" data-type="minus" data-field="">
                                                    <i class="icon-minus"></i>
                                                </button>
                                            </span>
                                        </div>
                                    </div>
                                </div>

<!-- 在 cart_detail.html 中修改刪除按鈕部分 -->
<cart-remove-button data-index="1">
    <form method="POST" action="{% url 'cart:remove_from_cart' item.item_id %}" class="remove-form" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="remove-btn" style="background: none; border: none; padding: 0; cursor: pointer; outline: none;">
            <svg xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 16 16"
                aria-hidden="true"
                focusable="false"
                class="icon icon-remove">
                <path d="M14 3h-3.53a3.07 3.07 0 00-.6-1.65C9.44.82 8.8.5 8 .5s-1.44.32-1.87.85A3.06 3.06 0 005.53 3H2a.5.5 0 000 1h1.25v10c0 .28.22.5.5.5h8.5a.5.5 0 00.5-.5V4H14a.5.5 0 000-1zM6.91 1.98c.23-.29.58-.48 1.09-.48s.85.19 1.09.48c.2.24.3.6.36 1.02h-2.9c.05-.42.17-.78.36-1.02zm4.84 11.52h-7.5V4h7.5v9.5z" fill="currentColor"/>
                <path d="M6.55 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5zM9.45 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5z" fill="currentColor"/>
            </svg>
        </button>
    </form>
</cart-remove-button>
                            </div>
                        </quantity-popover>
                    </td>

<!-- 單項總價顯示 - 桌面端 -->
<td class="cart-item__totals right small-hide">
    <div class="cart-item__price-wrapper">
        <span class="cart-item__final-price item-total">
            ${{ item.total_price|floatformat:"-2" }}
        </span>
    </div>
</td>
                    
                    </tr>
                </tbody>
                {% endfor %}

            </table>
            <!--end cart item table -->
        </div>
    </div>
</section>
{% endif %}
<!-- End Cart Items Section -->


<!-- Cart Total Section -->
<section class="ftco-section ftco-cart">
    <div class="container">
        {% with total_item=cart|length %}
        {% if total_item > 0 %}
        <div class="row justify-content-end">
            <div class="col col-lg-4 col-md-6 cart-wrap">
                <div class="cart-wrap">
                    <div class="cart-total">
                        <h3 class="billing-heading mb-4">總計</h3>
                        <p class="d-flex">
                            <span style="text-align:left">優惠碼</span>
                            <span style="text-align:right">不適用</span>
                        </p>

                        <!-- With authentication checks -->
                        {% if cart %}
                        <p class="d-flex total-price align-items-center">
                            {% comment %} <span>總計 {{ total_items }}</span> {% endcomment %}
                            <span>總計</span>
                            <!-- Cart Total Price for payment -->
                            <span class="total-amount" style="text-align:right">${{ cart.get_total_price|floatformat:0 }}</span>
                            <form method="POST" action="{% url 'cart:create_order' %}" id="checkout-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary btn-primary-outline">
                                {% if user.is_authenticated %}確認{% else %}已有帳戶？ 請先登入結帳{% endif %}
                            </button>
                            </form>
                            {% if not user.is_authenticated %}
                                <div class="mt-3">
                                    <p>已有帳戶？ <a href="{% url 'account_login' %}?next={% url 'eshop:order_confirm' %}">登入</a> 可更快完成結帳。</p>
                                </div>
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% elif not order %}
        <div class="row justify-content-center align-items-center">
            <div class="col col-lg-4 col-md-6 cart-wrap">
                <div class="cart-total">
                    <h4 class="text-center mb-2">購物車沒有物品</h4>
                    <h4 class="text-center mb-5">歡迎閣下購買我們的產品 :)</h4>
                    <a href="{% url 'index' %}" class="btn btn-primary btn-outline-primary px-4 py-3">返回</a>
                </div>
            </div>
        </div>
        {% endif %}
        {% endwith %}
        <!-- end Cart detail -->
    </div>
</section>
<!-- End Cart Total Section -->

<div class="flexable-vh-20"></div>




{% comment %}
JS 處理前端購物車的動態行為 - 與後端透過 AJAX通訊, 以更新購物車+/- item,並反映DOM 中變化
{% endcomment %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 修復：表單提交
        document.getElementById('checkout-form')?.addEventListener('submit', function(e) {
            console.log('Form submitted normally');
        });

        // 修復：刪除商品
        document.querySelectorAll('.remove-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                fetch(this.action, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(response => {
                    if (response.ok) window.location.reload();
                });
            });
        });

        // 處理數量按鈕
        document.querySelectorAll('.quantity-left-minus, .quantity-right-plus').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                if (this.disabled) return;
                this.disabled = true;
                setTimeout(() => { this.disabled = false; }, 300);

                const cartItem = this.closest('.cart-item');
                const input = cartItem.querySelector('.quantity-input');
                const itemKey = input.dataset.itemKey;
                const price = parseFloat(input.dataset.itemPrice.replace(/[^\d.-]/g, '')) || 0;
                let newQuantity = parseInt(input.value) || 1;

                if (this.classList.contains('quantity-left-minus')) {
                    newQuantity = Math.max(1, newQuantity - 1);
                } else {
                    newQuantity += 1;
                }
                newQuantity = Math.min(newQuantity, 100);
                input.value = newQuantity;
                updateCartItem(cartItem, input, itemKey, price, newQuantity);
            });
        });

        // 處理手動輸入
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function(e) {
                const cartItem = this.closest('.cart-item');
                const itemKey = this.dataset.itemKey;
                const price = parseFloat(this.dataset.itemPrice.replace(/[^\d.-]/g, '')) || 0;
                let newQuantity = parseInt(this.value) || 1;
                
                if (isNaN(newQuantity) || newQuantity < 1) newQuantity = 1;
                if (newQuantity > 100) newQuantity = 100;
                this.value = newQuantity;
                updateCartItem(cartItem, this, itemKey, price, newQuantity);
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                }
            });
            
            input.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^\d]/g, '');
                if (this.value.length > 3) this.value = this.value.slice(0, 3);
            });
            
            input.addEventListener('focus', function() {
                this.select();
            });
        });

        // 統一的購物車更新函數
        function updateCartItem(cartItem, input, itemKey, price, newQuantity) {
            // 更新本地顯示
            let itemTotal = price * newQuantity;
            let itemTotalFormatted = Number.isInteger(itemTotal) ? 
                itemTotal.toString() : parseFloat(itemTotal.toFixed(2)).toString();

            cartItem.querySelectorAll('.item-total').forEach(element => {
                let currentText = element.textContent || '';
                let priceMatch = currentText.match(/\$?([\d.]+)/);
                element.textContent = priceMatch ? 
                    currentText.replace(priceMatch[1], itemTotalFormatted) : 
                    '$' + itemTotalFormatted;
            });

            // AJAX 更新後端購物車
            fetch("{% url 'cart:update_cart' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ item_key: itemKey, quantity: newQuantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const totalAmountElement = document.querySelector('.total-amount');
                    if (totalAmountElement && data.cart_total_price) {
                        let totalPrice = data.cart_total_price.toString();
                        totalAmountElement.textContent = totalPrice.startsWith('$') ? 
                            totalPrice : '$' + totalPrice;
                    }
                    document.querySelectorAll('.cart-count').forEach(element => {
                        element.textContent = data.cart_total_items;
                    });
                }
            });
        }

        // 初始化：確保價格有$符號
        document.querySelectorAll('.item-total').forEach(element => {
            let text = element.textContent || '';
            if (text.trim() && !text.includes('$')) {
                element.textContent = '$' + text;
            }
        });
        const totalAmountElement = document.querySelector('.total-amount');
        if (totalAmountElement) {
            let text = totalAmountElement.textContent || '';
            if (text.trim() && !text.includes('$')) {
                totalAmountElement.textContent = '$' + text;
            }
        }
    });
</script>

<style>
    /* 修復刪除按鈕樣式 - 內聯樣式確保覆蓋 */
    .ftco-cart .remove-form button.remove-btn,
    .ftco-cart .remove-form button {
        border: none !important;
    }

</style>
{% endblock content %}