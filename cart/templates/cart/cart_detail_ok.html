<!-- cart_detail -->
{% extends "betweencoffee_delivery/base.html" %}
{% load static %}
{% block title %}Between Coffee - Cart{% endblock %}

{% block content %}


<!-- subpage Header-->
<section class="ftco-section subpage-spaceing-vh-20">
    <div class="container">
        <div class="row justify-content-center align-items-center">
            <div class="col-lg-12 col-md-12 col-sm-12  ftco-animate">
                <p class="cart-head d-flex mb-3 mt-5">
            <span class="h1">購物車</span>
            <span class="text-right">
                <a href="{% url 'coffee_menu' %}"><i class="icon material-symbols-outlined">undo</i> 繼續購物</a>
            </span>
                </p>
            </div>
        </div>
    </div>
</section>
<!-- end subpage header-->


<!-- Cart Item Section - Render for loop-->
{% if cart %}
<section class="ftco-cart">
    <div class="container ftco-animate">
        <div class="cart__items">
            <!-- cart item table -->
            <table class="cart-items">
                <caption hidden class="visually-hidden small-hide">
                    您的購物車
                </caption>
                <thead>
                    <tr>
                        <th class="caption-with-letter-spacing" colspan="2" scope="col">商品</th>
                        <th class=" large-up-hide right caption-with-letter-spacing" colspan="1" scope="col">合計</th>
                        <th class="cart-items__heading--wide cart-items__heading--quantity small-hide caption-with-letter-spacing" colspan="1" scope="col">数量</th>
                        <th class="small-hide right caption-with-letter-spacing" colspan="1" scope="col">合計</th>
                    </tr>
                </thead>

                <tbody>
                {% for item in cart %}
                    <tr class="cart-item">
                    <td class="cart-item__media">
                        <div class="cart-item__image-container cart-item__image__cut-white-space">
                            <a href="{% if item.type == 'coffee' %}{% url 'coffee' item.product_id %}{% else %}{% url 'bean' item.product_id %}{% endif %}" 
                            class="cart-item__name cart-list break">
                                <img src="{{ item.image }}" class="cart-item__image" alt="item.image">
                            </a>
                        </div>
                    </td>

                    <td class="cart-item__details">
                        <a href="" class="cart-item__name cart-list break">
                            <p hidden>
                                {% if item.type == 'coffee' %}- 咖啡 -
                                {% elif item.type == 'bean' %}- 咖啡豆 -
                                {% endif %}
                            </p>
                            <a href="{% if item.type == 'coffee' %}{% url 'coffee' item.product_id %}{% else %}{% url 'bean' item.product_id %}{% endif %}" 
                            class="cart-item__name cart-list break">
                                <h5>{{ item.name }}</h5>
                            </a>

                        <div class="cart-option">
                            ${{ item.price|floatformat:0 }}
                        </div>
                        <div class="cart-option-2">
                        {% if item.type == 'coffee' %}
                                <p>
                                    <i class="icon material-symbols-outlined">water_full</i>
                                    杯量 : 
                                    <strong>
                                    {% if item.cup_level == 'Small' %}細
                                    {% elif item.cup_level == 'Medium' %}中
                                    {% elif item.cup_level == 'Large' %}大
                                    {% endif %}
                                    </strong>
                                    <br>
                                    <i class="icon material-symbols-outlined">humidity_mid</i>
                                    奶量 :
                                    <strong>
                                    {% if item.milk_level == 'Light' %}少
                                    {% elif item.milk_level == 'Medium' %}正常
                                    {% elif item.milk_level == 'Extra' %}追加
                                    {% endif %}
                                    </strong>
                                </p>
                            {% elif item.type == 'bean' %}
                                <p class="pt-2">
                                    <i class="icon material-symbols-outlined">roller_shades</i>
                                    研磨 :
                                    <strong>
                                    {% if item.roast_level == 'Non' %}不研磨
                                    {% elif item.roast_level == 'Light' %}細
                                    {% elif item.roast_level == 'Medium' %}中
                                    {% elif item.roast_level == 'Deep' %}粗
                                    {% endif %}
                                    </strong>
                                </p>
                            {% endif %}
                            </div>
                        <dl></dl>
                        <p class="product-option"></p>
                    </td>

                    <!-- Mobile hide -->
                    <td class="cart-item__totals right large-up-hide">
                        <div class="cart-item__price-wrapper">
                            <span class="cart-item__final-price item-total">
                            ${{ item.total_price }}
                            </span>
                        </div>
                    </td>

                    <td class="cart-item__quantity">
                        <quantity-popover>
                            <div class="cart-item__quantity-wrapper quantity-popover-wrapper">
                                <div class="cart-item-quantity">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <button type="button" class="quantity-right-plus btn" data-type="plus" data-field="">
                                                    <i class="icon-plus"></i>
                                                </button>
                                            </span>
                                                <input 
                                                class="form-control quantity-input" 
                                                value="{{ item.quantity }}" 
                                                min="1" 
                                                data-item-key="{{ item.item_id }}" 
                                                data-item-price="{{ item.price }}"  
                                                >
                                            <span class="input-group-btn">
                                                <button type="button" class="quantity-left-minus btn" data-type="minus" data-field="">
                                                    <i class="icon-minus"></i>
                                                </button>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <cart-remove-button data-index="1">
                                    <a href="{% url 'cart:remove_from_cart' item.item_id %}" id="product-remove">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 16 16"
                                            aria-hidden="true"
                                            focusable="false"
                                            class="icon icon-remove">
                                            <path d="M14 3h-3.53a3.07 3.07 0 00-.6-1.65C9.44.82 8.8.5 8 .5s-1.44.32-1.87.85A3.06 3.06 0 005.53 3H2a.5.5 0 000 1h1.25v10c0 .28.22.5.5.5h8.5a.5.5 0 00.5-.5V4H14a.5.5 0 000-1zM6.91 1.98c.23-.29.58-.48 1.09-.48s.85.19 1.09.48c.2.24.3.6.36 1.02h-2.9c.05-.42.17-.78.36-1.02zm4.84 11.52h-7.5V4h7.5v9.5z" fill="currentColor"/>
                                            <path d="M6.55 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5zM9.45 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5z" fill="currentColor"/>
                                        </svg>
                                    </a>
                                </cart-remove-button>
                            </div>
                        </quantity-popover>
                    </td>

                    <!-- Mobile Small hide -->
                    <td class="cart-item__totals right small-hide">

                        <div class="cart-item__price-wrapper">
                            <span class="cart-item__final-price item-total">${{ item.total_price|floatformat:"-2" }}</span>
                        </div>
                    </td>
                    
                    </tr>
                </tbody>
                {% endfor %}

            </table>
            <!--end cart item table -->
        </div>
    </div>
</section>
{% endif %}
<!-- End Cart Items Section -->


<!-- Cart Total Section -->
<section class="ftco-section ftco-cart">
    <div class="container">
        {% with total_item=cart|length %}
        {% if total_item > 0 %}
        <div class="row justify-content-end ftco-animate">
            <div class="col col-lg-4 col-md-6 cart-wrap">
                <div class="cart-wrap ftco-animate">
                    <div class="cart-total">
                        <h3 class="billing-heading mb-4">總計</h3>
                        <p class="d-flex">
                            <span style="text-align:left">優惠碼</span>
                            <span style="text-align:right">不適用</span>
                        </p>
                        <p class="d-flex total-price align-items-center">
                            <span>總數 {{ total_items }} {{ total_items|pluralize }}</span>
                            <!-- Cart Total Price for payment -->
                            <span class="total-amount" style="text-align:right">${{ cart.get_total_price|floatformat:0 }}</span>
                            <form method="POST" action="{% url 'cart:create_order' %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-primary-outline">確認</button>
                            </form>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {% elif not order %}
        <div class="row justify-content-center align-items-center">
            <div class="col col-lg-4 col-md-6 cart-wrap ftco-animate">
                <div class="cart-total">
                    <h4 class="text-center mb-2">購物車沒有物品</h4>
                    <h4 class="text-center mb-5">歡迎閣下購買我們的產品 :)</h4>
                    <a href="{% url 'index' %}" class="btn btn-primary btn-outline-primary px-4 py-3">返回</a>
                </div>
            </div>
        </div>
        {% endif %}
        {% endwith %}
        <!-- end Cart detail -->
    </div>
</section>
<!-- End Cart Total Section -->

<div class="flexable-vh-20"></div>




{% comment %}
JS 處理前端購物車的動態行為
與後端透過 AJAX通訊, 以更新購物車並反映 DOM 中的變化
{% endcomment %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Event listeners for quantity buttons
        document.querySelectorAll('.quantity-left-minus, .quantity-right-plus').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();

                // Find the closest cart item row
                const cartItem = this.closest('.cart-item');
                
                // Get the quantity input
                const input = cartItem.querySelector('.quantity-input');
                const itemKey = input.dataset.itemKey;
                const price = parseFloat(input.dataset.itemPrice);
                let newQuantity = parseInt(input.value);

                // Update quantity logic
                if (this.classList.contains('quantity-left-minus')) {
                    newQuantity = Math.max(1, newQuantity - 1);
                } else {
                    newQuantity += 1;
                }
                input.value = newQuantity;

                // Find total price elements
                const itemTotalElements = cartItem.querySelectorAll('.item-total');
                
                // Calculate new total
                let itemTotal = (price * newQuantity).toFixed(2);
                if (itemTotal.endsWith('.00')) {
                    itemTotal = itemTotal.slice(0, -3);
                }
                
                // Update all total price displays in the row
                itemTotalElements.forEach(element => {
                    element.innerHTML = `<span class="price">$${itemTotal}</span>`;
                });

                // AJAX request
                fetch("{% url 'cart:update_cart' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        item_key: itemKey,
                        quantity: newQuantity
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update cart total amount
                        document.querySelector('.total-amount').textContent = 
                            '$' + data.cart_total_price;
                        
                        // Update cart count in navbar
                        document.querySelectorAll('.cart-count').forEach(element => {
                            element.textContent = data.cart_total_items;
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    });
</script>

{% endblock content %}


{% comment %} 
範例工作流程：
當使用者點擊 + 或 - 按鈕時，JavaScript：

更新數量輸入欄位。

使用新數量向 update_cart 視圖發送 AJAX 請求。

update_cart 視圖更新會話資料並傳回更新後的總數（例如，cart_total_price、item_total_price）。

JavaScript 接收回應並更新 DOM 以反映新的總數。

DOM 代表 HTML 頁面的結構。 JavaScript 操縱 DOM 來動態更新購物車的 UI，而無需重新載入整個頁面


當後端響應時：

JavaScript 使用新的 item_total_price 更新 .item-total 元素。

JavaScript 使用新的 cart_total_price 更新 .total-amount 元素。



//////////////////////

逐步流程：
使用者操作：

使用者點擊 + 或 - 按鈕來更改商品的數量。

JavaScript的：

捕獲點擊事件。

更新 DOM 中的數量輸入欄位。

使用新數量向 update_cart 視圖發送 AJAX 請求。

後端（購物車會話）：

update_cart 視圖接收請求。

更新會話中的購物車資料。

重新計算總額（cart_total_price、item_total_price）。

在 JSON 回應中傳回更新後的總數。

JavaScript的：

接收 JSON 回應。

更新 DOM 來反映新的總數：

使用新的 item_total_price 更新 .item-total 元素。

使用新的 cart_total_price 更新 .total-amount 元素。

DOM：

向使用者反映更新後的總數，而無需重新載入頁面。




5.視覺表現
以下是該關係的直觀表示：

複製
使用者操作（點擊 + 或 -）
|
五
JavaScript（事件監聽器）
|
五
AJAX 請求（取得 API）
|
五
後端（購物車會話）
|
五
JSON 回應（更新總數）
|
五
JavaScript（DOM 操作）
|
五
DOM（更新的 UI）


6. 要記住的要點
會話儲存：

購物車資料儲存在會話中，使其在頁面重新載入和導航時持久存在。

每個用戶都有自己的購物車數據。

JavaScript的：

處理動態更新而無需重新載入整個頁面。

透過 AJAX 與後端通訊。

DOM：

表示購物車的 UI。

透過 JavaScript 動態更新以反映購物車的變化。

後端：

管理購物車邏輯和計算。

確保數據一致性 {% endcomment %}

