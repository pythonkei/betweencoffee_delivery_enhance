# 時間服務遷移指南

## 概述

本指南介紹如何從舊的分散時間計算邏輯遷移到新的統一時間服務模組。新的時間服務模組提供了更清晰、更一致的時間計算和格式化功能。

## 新模組結構

```
eshop/time_calculation/
├── __init__.py              # 模組初始化
├── unified_time_service.py  # 統一時間服務主類
├── constants.py             # 時間常量定義
├── time_calculators.py      # 時間計算器
├── time_formatters.py       # 時間格式化器
└── time_validators.py       # 時間驗證器
```

## 遷移步驟

### 步驟 1: 導入新模組

將現有代碼中的導入語句從：

```python
from eshop.time_service import time_service
```

更改為：

```python
from eshop.time_calculation import unified_time_service
```

或者使用兼容層：

```python
from eshop.time_service_new import time_service  # 兼容層
```

### 步驟 2: 方法對照表

| 舊方法 | 新方法 | 說明 |
|--------|--------|------|
| `time_service.get_hong_kong_time()` | `unified_time_service.get_hong_kong_time()` | 獲取香港時間 |
| `time_service.format_time_for_display(dt, include_date)` | `unified_time_service.format_time_for_display(dt, format_type)` | 格式化時間顯示 |
| `time_service.calculate_preparation_time(coffee_count)` | `unified_time_service.calculate_preparation_time(coffee_count)` | 計算製作時間 |
| `time_service.get_remaining_minutes(target_time)` | `unified_time_service.calculate_remaining_minutes(target_time)` | 計算剩餘分鐘數 |
| `time_service.calculate_quick_order_pickup_time(order)` | `unified_time_service.calculate_quick_order_times(order)` | 計算快速訂單時間 |
| `time_service.format_pickup_time_for_order(order)` | `unified_time_service.format_pickup_time_for_order(order)` | 格式化訂單取貨時間 |
| `time_service.estimate_order_time(order)` | `unified_time_service.get_order_time_summary(order)` | 獲取訂單時間摘要 |

### 步驟 3: 新功能介紹

#### 1. 時間格式化器 (`time_formatters.py`)

```python
from eshop.time_calculation.time_formatters import TimeFormatters

# 格式化持續時間
formatted = TimeFormatters.format_duration_minutes(65)  # "1小時5分鐘"

# 格式化取貨時間顯示
display = TimeFormatters.format_pickup_time_display('10', is_urgent=True)

# 格式化訂單時間摘要
summary = TimeFormatters.format_order_time_summary('quick', True, False)
```

#### 2. 時間驗證器 (`time_validators.py`)

```python
from eshop.time_calculation.time_validators import TimeValidators

# 驗證取貨時間選擇
is_valid = TimeValidators.is_valid_pickup_choice('15')

# 驗證時間有效性
is_valid = TimeValidators.is_valid_datetime(some_time)

# 驗證快速訂單時間
is_valid, error = TimeValidators.validate_quick_order_times(estimated_time, latest_start_time)
```

#### 3. 時間計算器 (`time_calculators.py`)

```python
from eshop.time_calculation.time_calculators import TimeCalculators

# 計算隊列等待時間
wait_time = TimeCalculators.calculate_queue_wait_time(queue_position, current_preparing_time)

# 計算進度百分比
progress = TimeCalculators.calculate_progress_percentage(start_time, end_time, current_time)

# 檢查時間是否緊急
is_urgent = TimeCalculators.is_time_urgent(latest_start_time, current_time)
```

### 步驟 4: 常量使用

```python
from eshop.time_calculation.constants import TimeConstants

# 獲取時區
hk_tz = TimeConstants.HONG_KONG_TZ

# 獲取製作時間配置
config = TimeConstants.get_preparation_time_config()

# 獲取快速訂單顯示文本
display = TimeConstants.get_quick_order_display('10')  # "10分鐘後"
```

## 遷移示例

### 示例 1: 訂單時間計算

**舊代碼:**
```python
from eshop.time_service import time_service

def get_order_time_info(order):
    # 計算製作時間
    prep_time = time_service.calculate_preparation_time(order.coffee_count)
    
    # 計算剩餘時間
    remaining = time_service.get_remaining_minutes(order.estimated_ready_time)
    
    # 格式化顯示
    display = time_service.format_pickup_time_for_order(order)
    
    return {
        'prep_time': prep_time,
        'remaining': remaining,
        'display': display
    }
```

**新代碼:**
```python
from eshop.time_calculation import unified_time_service

def get_order_time_info(order):
    # 獲取完整的時間摘要
    time_summary = unified_time_service.get_order_time_summary(order)
    
    # 計算剩餘時間
    remaining = unified_time_service.calculate_remaining_minutes(
        order.estimated_ready_time
    )
    
    # 格式化顯示
    display = unified_time_service.format_pickup_time_for_order(order)
    
    return {
        'prep_time': time_summary.get('preparation_minutes', 0),
        'remaining': remaining,
        'display': display,
        'summary': time_summary
    }
```

### 示例 2: 快速訂單處理

**舊代碼:**
```python
from eshop.time_service import time_service

def process_quick_order(order):
    # 計算取貨時間
    pickup_info = time_service.calculate_quick_order_pickup_time(order)
    
    if pickup_info:
        order.estimated_ready_time = pickup_info['estimated_pickup_time']
        order.latest_start_time = pickup_info['latest_start_time']
        order.save()
```

**新代碼:**
```python
from eshop.time_calculation import unified_time_service

def process_quick_order(order):
    # 計算快速訂單時間
    quick_times = unified_time_service.calculate_quick_order_times(order)
    
    if quick_times:
        order.estimated_ready_time = quick_times['estimated_pickup_time']
        order.latest_start_time = quick_times['latest_start_time']
        order.save()
```

## 測試遷移

### 1. 運行測試腳本

```bash
python test_time_service.py
```

### 2. 檢查兼容性

使用兼容層進行漸進式遷移：

```python
# 暫時使用兼容層
from eshop.time_service_new import time_service

# 原有代碼無需修改
prep_time = time_service.calculate_preparation_time(2)
```

### 3. 驗證功能

檢查以下功能是否正常工作：
- [ ] 時間計算（製作時間、等待時間）
- [ ] 時間格式化（顯示格式、相對時間）
- [ ] 時間驗證（取貨選擇、時間有效性）
- [ ] 快速訂單處理
- [ ] 訂單時間摘要

## 常見問題

### Q1: 遷移後時間計算不一致怎麼辦？
A: 檢查常量配置是否正確，特別是 `TimeConstants` 中的製作時間參數。

### Q2: 如何處理時區問題？
A: 所有時間計算都使用香港時區，確保使用 `unified_time_service.get_hong_kong_time()` 獲取當前時間。

### Q3: 遷移過程中出現錯誤怎麼辦？
A: 可以使用兼容層 `time_service_new.py` 進行漸進式遷移，逐步替換舊方法。

### Q4: 如何擴展新的時間服務？
A: 可以在相應的模組中添加新功能：
- 新的計算邏輯：添加到 `time_calculators.py`
- 新的格式化方式：添加到 `time_formatters.py`
- 新的驗證規則：添加到 `time_validators.py`
- 新的常量：添加到 `constants.py`

## 後續步驟

1. **逐步遷移**: 從非關鍵功能開始遷移，逐步擴展到核心功能。
2. **監控日誌**: 遷移後監控日誌，檢查是否有時間相關的錯誤。
3. **性能測試**: 測試新模組的性能，確保不會影響系統響應時間。
4. **文檔更新**: 更新相關文檔，記錄新的時間服務使用方法。

## 聯繫支持

如果在遷移過程中遇到問題，請檢查：
1. 測試腳本輸出
2. 日誌文件中的錯誤信息
3. 常量配置是否正確

如有需要，可以參考 `test_time_service.py` 中的測試用例來驗證功能。